name: Django Tests for All Labs

on: [push, pull_request]

jobs:
  test-django:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          # Assuming all labs share same requirements
          pip install -r requirements.txt

      - name: Run tests for all labs
        run: |
          # List of labs and one page per lab
          declare -A LAB_PAGES=(
            ["lab2"]="/"
            ["lab3"]="/books/456"
            ["lab4"]="/books/aboutus/"
            ["lab5"]="/books/html5/links"
            ["lab6"]="/books/search/"
          )

          for lab in "${!LAB_PAGES[@]}"; do
            echo "▶️ Starting $lab server..."
            nohup python $lab/libraryproject/manage.py runserver 0.0.0.0:8000 &
            sleep 10

            page=${LAB_PAGES[$lab]}
            echo "Testing $lab at http://127.0.0.1:8000${page}"

            if curl -s "http://127.0.0.1:8000${page}" > /dev/null; then
              echo "✅ $lab page ${page} works"
            else
              echo "❌ $lab page ${page} failed"
              exit 1
            fi

            # Kill the server before starting the next lab
            pkill -f "runserver"
            sleep 3
          done
